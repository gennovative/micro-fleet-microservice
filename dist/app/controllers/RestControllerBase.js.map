{"version":3,"sources":["app/controllers/RestControllerBase.ts"],"names":[],"mappings":"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","file":"RestControllerBase.js","sourcesContent":["import * as express from 'express';\r\nimport { decorate } from 'inversify';\r\nimport TrailsApp = require('trails');\r\nimport TrailsController = require('trails-controller');\r\n\r\nimport { injectable, inject, Guard } from 'back-lib-common-util';\r\nimport { SettingItem, SettingItemDataType, ISoftDelRepository,\r\n\tModelAutoMapper, JoiModelValidator } from 'back-lib-common-contracts';\r\nimport { IdProvider, Types } from 'back-lib-id-generator';\r\n\r\n\r\ndecorate(injectable(), TrailsController);\r\n\r\n@injectable()\r\nexport abstract class RestControllerBase<TModel extends IModelDTO> extends TrailsController {\r\n\r\n\tconstructor(\r\n\t\ttrailsApp: TrailsApp,\r\n\t\tprotected _ClassDTO?: { new(): TModel },\r\n\t\tprotected _repo?: ISoftDelRepository<TModel, any, any>,\r\n\t\tprotected _idProvider?: IdProvider\r\n\t) {\r\n\t\tsuper(trailsApp);\r\n\t}\r\n\r\n\tprotected get validator(): JoiModelValidator<TModel> {\r\n\t\treturn this._ClassDTO['validator'];\r\n\t}\r\n\r\n\tprotected get translator(): ModelAutoMapper<TModel> {\r\n\t\treturn this._ClassDTO['translator'];\r\n\t}\r\n\r\n\r\n\tpublic async countAll(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Counting model');\r\n\t\tlet payload = req.body();\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this._repo.countAll(payload.options);\r\n\t\t\tthis.reply(nRows, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async create(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Creating model');\r\n\t\tlet payload = req.body(),\r\n\t\t\tdto: TModel = this.translator.whole(payload.model, {\r\n\t\t\t\terrorCallback: err => this.validationError(err, res)\r\n\t\t\t});\r\n\t\tif (!dto) { return; }\r\n\r\n\t\ttry {\r\n\t\t\tdto = await this._repo.create(dto, payload.options);\r\n\t\t\tthis.reply(dto, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async deleteHard(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Hard deleting model');\r\n\t\tlet payload = req.body(),\r\n\t\t\t[err, pk] = this.validator.pk(payload.pk);\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(err, res);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this._repo.deleteHard(pk, payload.options);\r\n\t\t\tthis.reply(nRows, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async deleteSoft(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Soft deleting model');\r\n\t\tlet payload = req.body(),\r\n\t\t\t[err, pk] = this.validator.pk(payload.pk);\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(err, res);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this._repo.deleteSoft(pk, payload.options);\r\n\t\t\tthis.reply(nRows, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async exists(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Checking existence');\r\n\t\tlet payload = req.body();\r\n\t\ttry {\r\n\t\t\tlet gotIt: boolean = await this._repo.exists(payload.props, payload.options);\r\n\t\t\tthis.reply(gotIt, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async findByPk(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Finding model');\r\n\t\tlet payload = req.body(),\r\n\t\t\t[err, pk] = this.validator.pk(payload.pk);\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(err, res);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet dto: TModel = await this._repo.findByPk(pk, payload.options);\r\n\t\t\tthis.reply(dto, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async recover(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Recovering model');\r\n\t\tlet payload = req.body(),\r\n\t\t\t[err, pk] = this.validator.pk(payload.pk);\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(err, res);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this._repo.recover(pk, payload.options);\r\n\t\t\tthis.reply(nRows, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async patch(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Patching model');\r\n\t\tlet payload = req.body(),\r\n\t\t\tmodel = this.translator.partial(payload.model, {\r\n\t\t\t\terrorCallback: err => this.validationError(err, res)\r\n\t\t\t});\r\n\t\tif (!model) { return; }\r\n\r\n\t\ttry {\r\n\t\t\tlet updatedProps: Partial<TModel> = await this._repo.patch(model, payload.options);\r\n\t\t\tthis.reply(updatedProps, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async update(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Updating model');\r\n\t\tlet payload = req.body(),\r\n\t\t\tmodel: TModel = this.translator.whole(payload.model, {\r\n\t\t\t\terrorCallback: err => this.validationError(err, res)\r\n\t\t\t});\r\n\t\tif (!model) { return; }\r\n\r\n\t\ttry {\r\n\t\t\tlet updatedModel: TModel = await this._repo.update(model, payload.options);\r\n\t\t\tthis.reply(updatedModel, res);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(err, res);\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tprotected validationError(err, res: express.Response): void {\r\n\t\tsuper.log.error(err);\r\n\t\tres.status(412).send(err); // Precondition Failed\r\n\t}\r\n\r\n\tprotected internalError(err, res: express.Response): void {\r\n\t\tsuper.log.error(err);\r\n\t\tres.status(500).send('server.error.internal');\r\n\t}\r\n\r\n\tprotected reply(result, res: express.Response): void {\r\n\t\tres.status(200).send(result);\r\n\t}\r\n}"]}